# MaplatCore 開発ガイドライン

このドキュメントは、MaplatCoreプロジェクトの開発における固有の要件と制約事項をまとめたものです。

## プロジェクト概要

MaplatCoreは、ブラウザで動作する地図SDKライブラリです。OpenLayersをベースに、歴史地図と現代地図を重ね合わせて表示する機能を提供します。

## 重要な制約事項

### 1. 後方互換性の維持（最重要）
- **既存のAPIは変更しない**
- ブレークングチェンジは原則として許可されない
- 将来的なHTML Component化の際も後方互換性を維持する

### 2. ブラウザ専用ライブラリ
- サーバーサイド（Node.js/Deno）での実行は想定しない
- ビルド成果物はブラウザでのみ動作する
- 開発時のみNode.js環境を使用

### 3. 段階的な移行
- 動作確認を行いながら慎重に進める
- デザインのデグレーションが発生しないよう注意
- 各ステップでの動作確認が必須

## ビルドシステム要件

### 対応形式
1. **UMD** - `<script>`タグでの利用（モダンブラウザ対応、IE11非対応）
2. **ES6モジュール** - `import`での利用
3. **TypeScript** - 型定義の提供

### ビルドツール
- **Vite**への移行が必須（現在はWebpack）
- **Vitest**でのテスト（現在はJest）
- モダンブラウザのみ対応（IE11サポート不要）

## 依存関係の管理

### 外部ライブラリ
- **OpenLayers**: ピア依存関係として扱う
- **Mapbox/MapLibre**: 削除予定（OpenLayersのベクタレイヤーに置き換え）
- **Weiwudi**: タイルキャッシュライブラリ、継続使用
- **@maplat/tin**: @maplat/transformに置き換え予定

### 注意事項
- Weiwudiは座標変換ライブラリではなく、タイルキャッシュライブラリ
- @maplat/transformのインターフェースは@maplat/tinとほぼ同じ

## テスト戦略

### 現状
- 既存のテストはエラーが発生している状態
- 新規にテストを作成する必要がある

### 方針
- **Vitest**で単体テストを作成
- 当初はUIテスト（E2E）は不要
- 移行完了後にPlaywrightでE2Eテストを再設定

## 公開戦略

### レジストリ
- **npm**: @maplat/core（名前は維持）
- **JSR**: Denoでの Web開発対応のため公開

### Deno対応について
- Denoでの**Web開発**に対応（ブラウザで動作するコードの開発）
- Deno環境でのサーバーサイド実行は想定しない

## 開発時の注意事項

### コマンド実行時
- `npm run lint` - コードスタイルのチェック
- `npm run typecheck` - 型チェック
- `npm run test` - テストの実行（移行後）
- `npm run build` - ビルドの実行

### コード変更時
1. 既存のAPIシグネチャを変更しない
2. 新機能は既存機能に影響を与えないよう実装
3. CSSやデザインの変更は慎重に（デグレーション防止）

## 移行ステップ

1. **ビルドシステムの移行**
   - WebpackからViteへ
   - 既存のビルド成果物と同等の出力を確認

2. **依存関係の整理**
   - @maplat/tin → @maplat/transform
   - Mapbox/MapLibreの削除（段階的に）

3. **テストの再構築**
   - Vitestでの単体テスト作成
   - 基本的な動作確認

4. **公開設定**
   - JSR対応の追加
   - npm/JSR両方への公開設定

## その他の情報

- プロジェクトはMerge_GPSブランチで開発中
- 開発完了後にmasterブランチにマージ
- Code4History TypeScript/Node.js/Denoコーディングルールを基本とするが、ブラウザライブラリの特性に合わせて調整

## MaplatCoreアーキテクチャの詳細

### 地図インスタンスの構成
MaplatCoreは前面地図と背面地図の2つの地図インスタンスを使用して座標変換を実現しています：

1. **前面地図（mapObject）**: ユーザーが直接操作する地図
2. **背面地図（backMap）**: オーバーレイ表示時の背景地図（overlayオプションがtrueの場合のみ）

### ソースクラスの階層構造
- **NowMap**: WMTS/XYZベースマップ（OSM、GSIなど）を扱うクラス
  - ベースマップとして使用される
  - `isBasemap_` = true, `isWmts_` = true
- **TmsMap**: WMTSオーバーレイを扱うクラス  
  - オーバーレイレイヤーとして使用される
  - `isBasemap_` = false, `isWmts_` = true
- **HistMap_tin**: カスタム座標系のオーバーレイを扱うクラス
  - 歴史地図など、独自の座標系を持つ地図
  - `isBasemap_` = false, `isWmts_` = false

### 地図切り替えのロジック
1. **ベースマップ → 非線形地図（HistMap_tin）**
   - 前面に非線形地図、背面に元のベースマップを配置
   - 座標変換追尾が有効になる
2. **非線形地図 → ベースマップ**
   - 前面にベースマップ、背面地図はクリア
   - 通常の地図表示に戻る
3. **TMSオーバーレイの場合**
   - 前面地図のオーバーレイレイヤーとして追加
   - ベースマップは維持される

### Mapbox/MapLibre移行に関する注意点
- MapboxStyleMapはNowMapと同様にベースマップとして扱う
- OpenLayersのVectorTileSourceを継承して実装
- ol-mapbox-styleはスタイル解析のみに使用し、レイヤー管理はMaplatCore側で行う
- VectorTileに対してsetupTileLoadFunctionを適用しないよう注意が必要

## 更新履歴

- 2025-06-25: 初版作成
- 2025-06-26: MaplatCoreアーキテクチャの詳細を追加